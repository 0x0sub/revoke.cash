// Note: this file contains TypeScript errors, but these errors are incorrect. I'm not sure how to fix them.

import { ImageResponse } from '@vercel/og';
import { getChainLogo, getChainName, isSupportedChain } from 'lib/utils/chains';
import { Exploit, formatExploitAmount, getExploitBySlug, getUniqueChainIds } from 'lib/utils/exploits';
import { NextRequest } from 'next/server';

export const config = {
  runtime: 'edge',
};

const revokeIcon = fetch(new URL('/public/assets/images/revoke.png', import.meta.url)).then((res) => res.arrayBuffer());

const OgImage = async (req: NextRequest) => {
  const { searchParams } = new URL(req.url);
  const slug = searchParams.get('slug');

  let exploit: Exploit;

  try {
    exploit = await getExploitBySlug(slug);
  } catch (e) {
    return new Response('Not found', { status: 404 });
  }

  const response = (
    <div tw="bg-white w-full h-full flex flex-col text-4xl leading-none items-center justify-center">
      <img width="400" src={await revokeIcon} />
      <div tw="text-6xl leading-none mt-8 mb-2">{exploit.name}</div>
      <div>{`${exploit.date} | ${formatExploitAmount(exploit.amount)} Stolen`}</div>
      <div tw="flex mt-8 mb-12">
        {getUniqueChainIds(exploit).map((chainId, index) => (
          <ChainLogo chainId={chainId} key={index} />
        ))}
      </div>
      <div tw="border-2 border-black py-2 pl-6 pr-4 rounded-2xl flex items-center">
        <div>Check if you're affected</div>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          tw="w-12 h-12 ml-2"
        >
          <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
        </svg>
      </div>
    </div>
  );

  return new ImageResponse(response, {
    width: 1200,
    height: 630,
  });
};

const ChainLogo = ({ chainId, size }: { chainId: number; size?: number }) => {
  const name = getChainName(chainId);
  const src = getChainLogo(chainId);

  return (
    <img
      src={`https://revoke.cash/${src}`}
      alt={name}
      width={size ?? 48}
      height={size ?? 48}
      tw="bg-white shrink-0 rounded-full mx-1 border border-black"
      style={{
        filter: !isSupportedChain(chainId) ? 'grayscale(100%)' : '',
      }}
    />
  );
};

export default OgImage;
